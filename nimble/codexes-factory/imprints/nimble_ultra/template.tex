\documentclass[11pt, twoside]{memoir}
\normalsize

% --- Page Geometry ---
\setstocksize{9in}{6in}
\settrimmedsize{9in}{6in}{*}
\settrims{0pt}{0pt}

\setlrmarginsandblock{1in}{1in}{*}
\setulmarginsandblock{0.75in}{*}{1} % Sets upper margin to 0.75in, lower to 1in (calculated)

\setheadfoot{24pt}{24pt}
\setlength{\headdrop}{2pt}
\setlength{\headsep}{12pt}
\checkandfixthelayout
\frenchspacing

% --- Font Setup ---
\usepackage{fontspec}
\setmainfont{Adobe Caslon Pro}
\setsansfont{Neulis Sans}

% --- Other Useful Packages ---
\usepackage{microtype}
\SetExtraKerning
  {encoding = *}
  {
    — = {-25, -25},  % em-dash
    – = {-25, -25}   % en-dash
  }

\usepackage{xcolor}
\usepackage{textcomp}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{layouts}
\usepackage{ifoddpage}
\usepackage{eso-pic}
\usepackage{calc}
\usepackage{footnote}
\usepackage{luaquotes}



% --- Hyphenation Fixes ---
\sloppy
\emergencystretch=1em
\tolerance=1000
\pretolerance=150

% --- Table of Contents Styling ---
\newcommand{\tocheadfont}{\Huge\sffamily\scshape}
\renewcommand{\cftpartfont}{\Large\bfseries}
\renewcommand{\cftchapterfont}{\bfseries}

% --- Custom Commands for Book Content ---

% Defines the formatting for quotes on the verso pages.
\newcommand{\formattedquote}[1]{%
  \parbox{0.85\textwidth}{%
    \itshape\fontsize{16}{20}\selectfont
    \raggedright #1%
  }%
}

% --- Watermark System (TikZ-free) ---
\newcommand{\watermarkfile}{}
\newcommand{\watermarkopacity}{0.08}
\newcommand{\watermarkscale}{0.75}

\newcommand{\setwatermarkimage}[1]{%
    \renewcommand{\watermarkfile}{#1}%
}

% Enhanced Debug Commands
\newcounter{mainmatterrecto}
\setcounter{mainmatterrecto}{0}
\newif\ifinmainmatter
\inmainmatterfalse

\let\oldmainmatter\mainmatter
\renewcommand{\mainmatter}{%
    \oldmainmatter
    \inmainmattertrue
    \setcounter{mainmatterrecto}{0}%
}

\let\oldbackmatter\backmatter
\renewcommand{\backmatter}{%
    \oldbackmatter
    \inmainmatterfalse
}

% Check if we should show watermark on this page
\newif\ifshouldshowwatermark
\shouldshowwatermarkfalse
\newcommand{\checkwatermarkpage}{%
    \shouldshowwatermarkfalse
    \ifinmainmatter
        \stepcounter{mainmatterrecto}%
        \ifnum\value{mainmatterrecto}=8\relax
            \shouldshowwatermarktrue
            \setcounter{mainmatterrecto}{0}% Reset counter
        \fi
    \fi
}

\newcommand{\placewatermark}{%
    \ifshouldshowwatermark
        \ifx\watermarkfile\empty
        \else
            \IfFileExists{\watermarkfile}{%
                \put(\LenToUnit{0.5\paperwidth-0.5\watermarkscale\paperwidth},%
                     \LenToUnit{0.5\paperheight-0.5\watermarkscale\paperheight}){%
                    \makebox(0,0)[c]{%
                        \includegraphics[width=\watermarkscale\paperwidth,opacity=\watermarkopacity]{\watermarkfile}%
                    }%
                }%
            }{}%
        \fi
    \fi
}

% This adds the watermark to every odd page (recto) if checkwatermarkpage allows it.
\AddToShipoutPictureBG*{%
    \checkoddpage
    \ifoddpage
        \checkwatermarkpage
        \placewatermark
    \fi
}

% Dot Grid Transcription Page Command
\newcommand{\dotgridpath}{dotgrid.png} % pilsa_prepress.py ensures this is in the build dir

% MODIFIED: Redesigned to guarantee content fits on a single page.
\newcommand{\dotgridtranscription}[1]{%
    \newpage
    \thispagestyle{empty}
    \begin{center} % Center the whole block horizontally
    \vspace*{\fill} % Push the block down from the top
    \begin{minipage}{0.9\textwidth} % A container for the content
        \centering % Center content inside the minipage
        \IfFileExists{\dotgridpath}{%
            \includegraphics[width=\textwidth,height=0.85\textheight,keepaspectratio]{\dotgridpath}%
        }{%
            [Dot Grid Page - Image Not Found]%
        }\par
        \vspace{1em}
        \small\sffamily #1
    \end{minipage}
    \vspace*{\fill} % Balance the top fill to center vertically
    \end{center}
}

% --- Page Style Setup ---
\makepagestyle{mypagestyle}

% Set up headers for odd and even pages
\makeoddhead{mypagestyle}{}{}{\large\scshape\sffamily xynapse traces}
\makeevenhead{mypagestyle}{\small\textit{\thetitle}}{}{} % \thetitle is set by \title{} in title_page.tex

% Set up footers (page numbers)
\makeoddfoot{mypagestyle}{}{}{\thepage}
\makeevenfoot{mypagestyle}{\thepage}{}{}

% Apply this style to all pages
\pagestyle{mypagestyle}

% Make sure chapter pages also use this style (instead of plain)
\aliaspagestyle{chapter}{mypagestyle}
\aliaspagestyle{cleared}{mypagestyle}
\aliaspagestyle{part}{mypagestyle}

\usepackage{indentfirst}


% --- Document Start ---
\begin{document}

% --- Frontmatter Inputs ---
\frontmatter
\input{title_page.tex}
\clearpage  % Copyright on page ii (verso after title)
\input{copyright_page.tex}
\cleardoublepage  % TOC starts on page iii (recto)
\input{table_of_contents.tex}
\cleardoublepage  % Publisher's note on recto
\input{publishers_note.tex}

% --- Mainmatter Inputs ---
\mainmatter
\input{transcription_note.tex}

% Try to include quotations if the file exists
\IfFileExists{quotations.tex}{\input{quotations.tex}}{%
  % Fallback quotations content
  \chapter{Sample Quotations}
  \formattedquote{This is a sample quotation to demonstrate the formatting.}
  \vspace{2em}
  \formattedquote{Another sample quotation with proper styling and formatting applied.}
}

% --- Backmatter Inputs ---
\backmatter
% These files are generated by pilsa_prepress.py if content exists
\IfFileExists{mnemonics.tex}{\input{mnemonics.tex}}{}
\IfFileExists{bibliography.tex}{\input{bibliography.tex}}{}

\end{document}