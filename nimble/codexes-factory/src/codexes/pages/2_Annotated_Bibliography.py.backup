import sys
import os
import jsonschema2md
import streamlit as st
from dotenv import load_dotenv
load_dotenv()
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
sys.path.append(project_root)

from src.codexes.modules.zotero.zotero2json import get_AI_bibliography, process_zotero_results

parser = jsonschema2md.Parser(
    examples_as_yaml=False,
    show_examples="all",
)

from src.codexes.core.utilities.utilities import (
    read_markdown_file,
    get_version_as_dict,
)


st.set_page_config(  # Alternate names: setup_page, page, layout
    layout="wide",  # Can be "centered" or "wide". In the future also "dashboard", etc.
    initial_sidebar_state="auto",  # Can be "auto", "expanded", "collapsed"
    page_title="Bibliography",  # String or None. Strings get appended with "â€¢ Streamlit".
    page_icon="resources/images/alasign.png",  # String, anything supported by st.image, or None.
)
# banner = build_trifecta_banner()
# st.image(banner[0], use_column_width=True)

sidebar_message = read_markdown_file("resources/markdown/sidebar_message.md")
st.sidebar.markdown(sidebar_message)
version2 = get_version_as_dict()
st.sidebar.write(version2)


@st.cache_data()
def show_bibliography_info():
    st.markdown(
        """*This bibliography is selective in that it covers only those journal articles, books, and news articles that I have found relevant to my work on the AI Lab for Book-Lovers.  It is not an exhaustive review of the entire literature, but it is a good starting point.*

*As far as I can tell, there is no single coherent community of people working on AI for books.  There are many different individuals or small isolated groups, and each has its own unique set of interests. Perhaps an expansion of this list could be a useful tool for building that community.*

**If you know of items about AI & books that should be added to this list, please send them to me via the link in the sidebar!**

*My comments are appended below each entry.  While CMOS17 section 14.10 recommends block indenting annotations, this produces an unbalanced grid, so I have opted to keep comments in standard margins.*

*Default display is in reverse date of publication. Note that there are quite a few non-dated items that are all at the bottom.* 

*Changing sort mode to 'dateModified' sorts by the date that my bibliographic metadata was last modified, so this is a good way to see what I have added recently.*

*Changing sort mode to 'creator' produces an alphabetical list by author. Note there are some missing author names that appear at the bottom.*
***"""
    )
    return


@st.cache_data()
def show_bibliography_sorted(sort="dateModified"):
    with st.spinner("Retrieving bibliography..."):
        try:
            results = get_AI_bibliography(sort=sort)
            t1 = process_zotero_results(results)
            st.markdown(t1, unsafe_allow_html=True)
        except Exception as e:
            st.error(f"Error retrieving bibliography: {str(e)}")
            raise


with st.expander("About this Bibliography", expanded=False):
    show_bibliography_info()

with st.expander("Questions and Suggestions", expanded=False):
    st.markdown(
        """Please send any questions or suggestions to [me](mailto:wfz@nimblebooks.com). I am always looking for new developments and new collaborators in the books & AI space!""")

with st.expander("Annotated Bibliography", expanded=True):
    with st.form(key="bib_form"):
        a, b = st.columns([5, 1])
        status_string = f"Currently sorted by last date the entry was modified.\n\nYou can change sort to: "
        sort_option = a.selectbox(status_string, ("date", "creator", "datModified"))
        # sort_option = "creator"
        # b = st.markdown(""" """)
        b.markdown("""
    ` `
    ` `
                       """)
        submitted = b.form_submit_button("Go")
        if submitted:
            show_bibliography_sorted(sort=sort_option)
            status_string = f"Currently sorted by {sort_option}. Change sort to: "
        else:
            show_bibliography_sorted(sort="dateModified")


