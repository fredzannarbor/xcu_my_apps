import streamlit as st
import pandas as pd
import yaml
import bcrypt
import sys
from pathlib import Path
from typing import Dict, Any, List

sys.path.insert(0, '/Users/fred/my-apps')

from yaml.loader import SafeLoader
from shared.ui import render_unified_sidebar

# --- Page Configuration ---
st.set_page_config(layout="wide", page_title="Admin Dashboard")

render_unified_sidebar(
    app_name="Codexes Factory - Admin Dashboard",
    nav_items=[]
)

# --- Path Configuration ---
# This pathing assumes the script is run from the project's root directory
# via `streamlit run src/codexes/codexes-factory-home-ui.py`.
PROJECT_ROOT = Path(__file__).resolve().parent.parent.parent.parent
CONFIG_PATH = PROJECT_ROOT / "resources" / "yaml" / "config.yaml"

# --- Translation ---
# A minimal translation dictionary for this standalone page.
translations = {
    "en": {
        "admin_title": "ðŸ‘‘ Admin Dashboard",
        "admin_welcome": "Welcome to the admin area, {name}.",
        "permission_denied": "You do not have permission to view this page. Please log in as an admin.",
        "config_not_found": f"Admin configuration file not found at `{CONFIG_PATH}`. Please create it from the example.",
        "config_load_error": "Error loading `config.yaml`: {e}",
        "config_save_error": "Failed to save `config.yaml`: {e}",
        "tab_dashboard": "Dashboard",
        "tab_user_mgmt": "User Management",
        "dashboard_header": "System Dashboard",
        "dashboard_info": "This area is under construction. Future dashboards will show:",
        "dashboard_item1": "- System health and resource usage",
        "dashboard_item2": "- User activity and sign-ups",
        "dashboard_item3": "- Sales and revenue metrics",
        "dashboard_item4": "- API usage statistics",
        "user_mgmt_header": "User Management",
        "user_config_invalid": "User configuration is missing or invalid in `config.yaml`.",
        "edit_user_header": "Edit or Add a New User",
        "username_label": "Username (must be unique)",
        "username_help": "Enter an existing username to edit, or a new one to add.",
        "name_label": "Full Name",
        "email_label": "Email Address",
        "password_label": "New Password",
        "password_help": "Leave blank to keep the existing password. This will be hashed automatically.",
        "role_label": "Role",
        "save_button": "Save User",
        "save_user_success": "User '{username}' saved successfully.",
        "save_user_error": "Failed to save user. Check logs.",
        "username_required_error": "Username is required to add or edit a user.",
        "delete_user_header": "Delete User",
        "delete_select_user": "Select user to delete",
        "delete_button": "Delete User Permanently",
        "delete_warning_self": "You cannot delete your own account.",
        "delete_select_warning": "Please select a user to delete.",
        "delete_success": "User '{username}' has been deleted.",
        "delete_confirmation": "Are you sure you want to delete user '{username}'? This cannot be undone."
    },
    "ko": {
        "admin_title": "ðŸ‘‘ ê´€ë¦¬ìž ëŒ€ì‹œë³´ë“œ",
        "admin_welcome": "{name}ë‹˜, ê´€ë¦¬ìž íŽ˜ì´ì§€ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.",
        "permission_denied": "ì´ íŽ˜ì´ì§€ë¥¼ ë³¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìžë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.",
        "config_not_found": f"ê´€ë¦¬ìž ì„¤ì • íŒŒì¼(`{CONFIG_PATH}`)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ˆì œ íŒŒì¼ì„ ë°”íƒ•ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.",
        "config_load_error": "`config.yaml` ë¡œë“œ ì˜¤ë¥˜: {e}",
        "config_save_error": "`config.yaml` ì €ìž¥ ì‹¤íŒ¨: {e}",
        "tab_dashboard": "ëŒ€ì‹œë³´ë“œ",
        "tab_user_mgmt": "ì‚¬ìš©ìž ê´€ë¦¬",
        "dashboard_header": "ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ",
        "dashboard_info": "ì´ ì˜ì—­ì€ í˜„ìž¬ ê°œë°œ ì¤‘ìž…ë‹ˆë‹¤. í–¥í›„ ëŒ€ì‹œë³´ë“œì— í‘œì‹œë  ë‚´ìš©:",
        "dashboard_item1": "- ì‹œìŠ¤í…œ ìƒíƒœ ë° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰",
        "dashboard_item2": "- ì‚¬ìš©ìž í™œë™ ë° ê°€ìž… í˜„í™©",
        "dashboard_item3": "- íŒë§¤ ë° ìˆ˜ìµ ì§€í‘œ",
        "dashboard_item4": "- API ì‚¬ìš© í†µê³„",
        "user_mgmt_header": "ì‚¬ìš©ìž ê´€ë¦¬",
        "user_config_invalid": "`config.yaml`ì˜ ì‚¬ìš©ìž ì„¤ì •ì´ ì—†ê±°ë‚˜ ìž˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.",
        "edit_user_header": "ì‚¬ìš©ìž ìˆ˜ì • ë˜ëŠ” ì¶”ê°€",
        "username_label": "ì‚¬ìš©ìž ì´ë¦„ (ê³ ìœ í•´ì•¼ í•¨)",
        "username_help": "ìˆ˜ì •í•˜ë ¤ë©´ ê¸°ì¡´ ì‚¬ìš©ìž ì´ë¦„ì„, ì¶”ê°€í•˜ë ¤ë©´ ìƒˆ ì‚¬ìš©ìž ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”.",
        "name_label": "ì „ì²´ ì´ë¦„",
        "email_label": "ì´ë©”ì¼ ì£¼ì†Œ",
        "password_label": "ìƒˆ ë¹„ë°€ë²ˆí˜¸",
        "password_help": "ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìœ ì§€í•˜ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš”. ìžë™ìœ¼ë¡œ í•´ì‹œ ì²˜ë¦¬ë©ë‹ˆë‹¤.",
        "role_label": "ì—­í• ",
        "save_button": "ì‚¬ìš©ìž ì €ìž¥",
        "save_user_success": "'{username}' ì‚¬ìš©ìžê°€ ì„±ê³µì ìœ¼ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.",
        "save_user_error": "ì‚¬ìš©ìž ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.",
        "username_required_error": "ì‚¬ìš©ìžë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ë ¤ë©´ ì‚¬ìš©ìž ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.",
        "delete_user_header": "ì‚¬ìš©ìž ì‚­ì œ",
        "delete_select_user": "ì‚­ì œí•  ì‚¬ìš©ìž ì„ íƒ",
        "delete_button": "ì‚¬ìš©ìž ì˜êµ¬ ì‚­ì œ",
        "delete_warning_self": "ìžì‹ ì˜ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
        "delete_select_warning": "ì‚­ì œí•  ì‚¬ìš©ìžë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.",
        "delete_success": "'{username}' ì‚¬ìš©ìžê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.",
        "delete_confirmation": "ì‚¬ìš©ìž '{username}'ì„(ë¥¼) ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    }
}


def T(key: str, **kwargs) -> str:
    """Shorthand for getting a translated string."""
    lang = st.session_state.get('language', 'en')
    return translations.get(lang, {}).get(key, f"[{key}]").format(**kwargs)


# --- Helper Functions ---

@st.cache_resource
def load_user_config() -> Dict[str, Any]:
    """Loads the user configuration file."""
    if not CONFIG_PATH.is_file():
        st.error(T("config_not_found"))
        st.stop()
    try:
        with open(CONFIG_PATH, 'r') as f:
            return yaml.load(f, Loader=SafeLoader)
    except Exception as e:
        st.error(T("config_load_error", error=e))
        st.stop()


def save_user_config(config: Dict[str, Any]):
    """Saves the user configuration file."""
    try:
        with open(CONFIG_PATH, 'w') as f:
            yaml.dump(config, f, default_flow_style=False)
        st.cache_resource.clear()  # Clear cache to force reload on next run
        return True
    except Exception as e:
        st.error(T("config_save_error", error=e))
        return False


# --- UI Components ---

def user_management_tab():
    """UI for managing users."""
    st.subheader(T("user_mgmt_header"))

    config = load_user_config()
    if not config or 'credentials' not in config or 'usernames' not in config:
        st.warning(T("user_config_invalid"))
        return

    users = config['credentials']['usernames']
    user_data = [
        {"username": username, **details}
        for username, details in users.items()
    ]
    df_users = pd.DataFrame(user_data).drop(columns=['password'], errors='ignore')
    st.dataframe(df_users, use_container_width=True, hide_index=True)

    st.divider()

    col1, col2 = st.columns(2)

    with col1:
        st.subheader(T("edit_user_header"))
        with st.form("user_form"):
            username = st.text_input(T("username_label"), help=T("username_help"))

            # Pre-fill form if editing an existing user
            existing_user = users.get(username, {}) if username else {}

            name = st.text_input(T("name_label"), value=existing_user.get("name", ""))
            email = st.text_input(T("email_label"), value=existing_user.get("email", ""))
            password = st.text_input(T("password_label"), type="password", help=T("password_help"))

            roles = ["user", "subscriber", "admin"]
            current_role_index = roles.index(existing_user.get("role", "user")) if existing_user else 0
            role = st.selectbox(T("role_label"), options=roles, index=current_role_index)

            submitted = st.form_submit_button(T("save_button"))

            if submitted:
                if not username:
                    st.error(T("username_required_error"))
                else:
                    new_user_data = {
                        "name": name,
                        "email": email,
                        "role": role,
                    }
                    if password:
                        hashed_pw = bcrypt.hashpw(password.encode("utf-8"), bcrypt.gensalt()).decode("utf-8")
                        new_user_data["password"] = hashed_pw
                    else:  # Keep old password if it exists
                        new_user_data["password"] = existing_user.get("password", "")

                    config['credentials']['usernames'][username] = new_user_data

                    if save_user_config(config):
                        st.success(T("save_user_success", username=username))
                        st.rerun()

    with col2:
        st.subheader(T("delete_user_header"))
        # Prevent admin from deleting themselves
        user_list = [u for u in users.keys() if u != st.session_state['username']]
        user_to_delete = st.selectbox(T("delete_select_user"), options=[""] + sorted(user_list))

        if user_to_delete:
            if st.button(T("delete_button"), type="primary", use_container_width=True):
                if user_to_delete:
                    # Final confirmation
                    if st.session_state.get('confirm_delete') == user_to_delete:
                        del config['credentials']['usernames'][user_to_delete]
                        if save_user_config(config):
                            st.success(T("delete_success", username=user_to_delete))
                            st.session_state['confirm_delete'] = None  # Reset confirmation
                            st.rerun()
                    else:
                        st.session_state['confirm_delete'] = user_to_delete
                        st.warning(T("delete_confirmation", username=user_to_delete))
                        # Use experimental_rerun to show the warning immediately
                        st.rerun()
                else:
                    st.warning(T("delete_select_warning"))


def main():
    """Main function to render the Admin Dashboard page."""
    st.set_page_config(page_title="Admin Dashboard", layout="wide")

    # Ensure session state is initialized for this page
    if 'language' not in st.session_state:
        st.session_state.language = 'en'

    st.title(T("admin_title"))

    # --- Access Control Gate ---
    # This check relies on the main `codexes-factory-home-ui.py` to have set the user's role.
    if st.session_state.get("user_role") != "admin":
        st.error(T("permission_denied"))
        st.stop()

    st.write(T("admin_welcome", name=st.session_state.get("name", "Admin")))

    tab1, tab2 = st.tabs([T("tab_dashboard"), T("tab_user_mgmt")])

    with tab1:
        st.header(T("dashboard_header"))
        st.info(T("dashboard_info"))
        st.markdown(T("dashboard_item1"))
        st.markdown(T("dashboard_item2"))
        st.markdown(T("dashboard_item3"))
        st.markdown(T("dashboard_item4"))

    with tab2:
        user_management_tab()


if __name__ == "__main__":
    main()